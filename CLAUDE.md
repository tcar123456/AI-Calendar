# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## å°ˆæ¡ˆæ¦‚è¿°

AI Calendar App - èªéŸ³æ™ºèƒ½è¡Œäº‹æ›†æ‡‰ç”¨ç¨‹å¼ã€‚ä½¿ç”¨ Flutterã€Firebase å’Œ AI æœå‹™ã€‚ç”¨æˆ¶å¯ä»¥è‡ªç„¶èªéŸ³å»ºç«‹è¡Œç¨‹ï¼ˆä¾‹å¦‚ï¼šã€Œæ˜å¤©ä¸‹åˆå…©é»åœ¨å’–å•¡å»³è·Ÿ Amy é–‹æœƒã€ï¼‰ï¼ŒAI è‡ªå‹•å°‡èªéŸ³è½‰æ›ç‚ºçµæ§‹åŒ–çš„è¡Œäº‹æ›†äº‹ä»¶ã€‚

## ğŸš¨ æ ¸å¿ƒé–‹ç™¼åŸå‰‡ï¼ˆå¿…è®€ï¼‰

### 1. ç©©å®šæ€§å„ªå…ˆ
- **ç›®æ¨™**ï¼šä¿æŒå°ˆæ¡ˆç©©å®šã€å¯ç¶­è­·ï¼Œé¿å…å¼•å…¥ä¸å¿…è¦çš„é¢¨éšª
- **åšæ³•**ï¼šå„ªå…ˆä¿® bugã€å„ªåŒ–ç¾æœ‰åŠŸèƒ½ï¼Œè€Œéå¤§è¦æ¨¡é‡æ§‹

### 2. ä¿®æ”¹å‰å¿…é ˆèªªæ˜ç†ç”±
- **å¼·åˆ¶è¦æ±‚**ï¼šä¿®æ”¹ä»»ä½•æª”æ¡ˆå‰ï¼Œå¿…é ˆå…ˆæ¸…æ¥šèªªæ˜ã€Œç‚ºä»€éº¼è¦æ”¹é€™å€‹æª”æ¡ˆã€
- **åŒ…å«å…§å®¹**ï¼š
  - è¦è§£æ±ºä»€éº¼å•é¡Œï¼Ÿ
  - ç‚ºä»€éº¼ç¾æœ‰ç¨‹å¼ç¢¼ç„¡æ³•æ»¿è¶³éœ€æ±‚ï¼Ÿ
  - ä¿®æ”¹çš„å½±éŸ¿ç¯„åœæ˜¯ä»€éº¼ï¼Ÿ

### 3. å¤šæª”æ¡ˆä¿®æ”¹éœ€è¦äº‹å‰è¨ˆç•«
- **æµç¨‹**ï¼š
  1. å…ˆæå‡ºå®Œæ•´çš„ä¿®æ”¹è¨ˆç•«ï¼ˆå“ªäº›æª”æ¡ˆã€ç‚ºä»€éº¼ã€æ€éº¼æ”¹ï¼‰
  2. ç­‰å¾…ç”¨æˆ¶ç¢ºèªè¨ˆç•«
  3. ç¢ºèªå¾Œæ‰é–‹å§‹å¯¦ä½œ
- **é©ç”¨æƒ…å¢ƒ**ï¼šæ¶‰åŠ 2 å€‹ä»¥ä¸Šæª”æ¡ˆçš„ä¿®æ”¹ã€æ¶æ§‹èª¿æ•´ã€æ–°å¢åŠŸèƒ½

### 4. ä¿æŒç¾æœ‰æ¶æ§‹
- **ä¸è¦**ï¼šéš¨æ„æ›´æ›æŠ€è¡“æ£§ï¼ˆå¦‚ Riverpod â†’ Blocã€Firebase â†’ Supabaseï¼‰
- **ä¸è¦**ï¼šé‡æ§‹æ²’æœ‰å•é¡Œçš„ç¨‹å¼ç¢¼ï¼ˆå¦‚ã€Œæ”¹æˆæ›´å„ªé›…çš„å¯«æ³•ã€ï¼‰
- **è¦**ï¼šåœ¨ç¾æœ‰æ¶æ§‹å…§è§£æ±ºå•é¡Œ
- **è¦**ï¼šåªæœ‰åœ¨ç¾æœ‰æ¶æ§‹ç¢ºå¯¦ç„¡æ³•æ»¿è¶³éœ€æ±‚æ™‚ï¼Œæ‰æè­°æ›´æ›æŠ€è¡“

### 5. ä½¿ç”¨ç¹é«”ä¸­æ–‡æºé€š
- æ‰€æœ‰å›è¦†ã€èªªæ˜ã€è¨»è§£è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡
- ç¨‹å¼ç¢¼è®Šæ•¸åç¨±ã€å‡½æ•¸åç¨±ä»ä½¿ç”¨è‹±æ–‡ï¼ˆéµå¾ªæ¥­ç•Œæ…£ä¾‹ï¼‰

### 6. æ¼¸é€²å¼æ”¹é€²
- å„ªå…ˆå°ç¯„åœä¿®æ”¹ã€å¿«é€Ÿé©—è­‰
- é¿å…ä¸€æ¬¡æ€§å¤§è¦æ¨¡æ”¹å‹•
- ç¢ºä¿æ¯æ¬¡æ”¹å‹•éƒ½èƒ½ç¨ç«‹æ¸¬è©¦å’Œå›æ»¾

## é–‹ç™¼æŒ‡ä»¤

### Flutter App (flutter_app/)

```bash
# å®‰è£ä¾è³´å¥—ä»¶
flutter pub get

# åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼ï¼ˆè‡ªå‹•åµæ¸¬è£ç½®ï¼‰
flutter run

# æŒ‡å®šå¹³å°åŸ·è¡Œ
flutter run -d chrome        # Web
flutter run -d [device-id]   # iOS/Android è£ç½®

# å»ºç½®
flutter build apk            # Android APK
flutter build ios            # iOS
flutter build web            # Web

# åŸ·è¡Œæ¸¬è©¦
flutter test

# æª¢æŸ¥ç¨‹å¼ç¢¼å•é¡Œ
flutter analyze

# æ¸…ç†å»ºç½®ç”¢ç‰©
flutter clean
```

### Firebase Functions (firebase/functions/)

```bash
# å®‰è£ä¾è³´å¥—ä»¶
npm install

# å»ºç½® TypeScript
npm run build

# ç›£çœ‹æ¨¡å¼ï¼ˆè‡ªå‹•é‡å»ºï¼‰
npm run build:watch

# éƒ¨ç½²åˆ° Firebase
npm run deploy

# æŸ¥çœ‹æ—¥èªŒ
npm run logs

# æœ¬åœ°æ¸¬è©¦ï¼ˆä½¿ç”¨æ¨¡æ“¬å™¨ï¼‰
npm run serve

# ç¨‹å¼ç¢¼æª¢æŸ¥
npm run lint
```

### Firebase Emulators (firebase/)

```bash
# å•Ÿå‹•æ‰€æœ‰æ¨¡æ“¬å™¨
firebase emulators:start

# æ¨¡æ“¬å™¨ UI: http://localhost:4000
# - Auth: port 9099
# - Functions: port 5001
# - Firestore: port 8080
# - Storage: port 9199
```

### Zeabur API (zeabur_api/)

```bash
# å®‰è£ä¾è³´å¥—ä»¶
pip install -r requirements.txt

# ä¸‹è¼‰ spaCy ä¸­æ–‡æ¨¡å‹ï¼ˆå¿…é ˆï¼‰
python -m spacy download zh_core_web_sm

# æœ¬åœ°åŸ·è¡Œ
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# å»ºç½® Docker æ˜ åƒ
docker build -t ai-calendar-api .

# åŸ·è¡Œ Docker å®¹å™¨
docker run -p 8000:8000 --env-file .env ai-calendar-api

# æ¸¬è©¦ API å¥åº·ç‹€æ…‹
curl http://localhost:8000/health
```

## æ¶æ§‹èªªæ˜

### ä¸‰å±¤å¼åˆ†æ•£æ¶æ§‹

```
Flutter App (Mobile/Web)
    â†“ Firebase SDK
Firebase Backend (Firestore + Storage + Functions)
    â†“ HTTP
Zeabur API (FastAPI Python) â†’ OpenAI APIs
```

### Flutter ç‹€æ…‹ç®¡ç† (Riverpod)

ä½¿ç”¨åˆ†å±¤å¼ Provider æ¶æ§‹ï¼š

**Provider å±¤ç´šï¼š**
- **Service Providers**: å–®ä¾‹æœå‹™ (`firebaseServiceProvider`, `voiceServiceProvider`)
- **Auth Flow**: `authStateProvider` â†’ `currentUserIdProvider` â†’ `userDataProvider`
- **Event Flow**: `authState` â†’ `allEventsProvider` â†’ `eventsProvider` (ä¾è¡Œäº‹æ›†ç¯©é¸)
- **Voice Flow**: `voiceServiceProvider` â†’ `isRecordingProvider` + `voiceProcessingRecordProvider`
- **Controllers**: `StateNotifierProvider` è™•ç†ç‹€æ…‹è®Šæ›´ (`authControllerProvider`, `eventControllerProvider`, `voiceControllerProvider`)

**æ ¸å¿ƒæ¨¡å¼ï¼š**
- UI ä½¿ç”¨ `ref.watch()` ç›£è½ providers
- UI å‘¼å« controller æ–¹æ³•åŸ·è¡Œå‹•ä½œ
- Controllers å‘¼å« services (Firebase/Voice)
- Services æ›´æ–° Firestore
- Providers é€é Firestore streams æ¥æ”¶å³æ™‚æ›´æ–°
- UI è‡ªå‹•é‡å»º

### èªéŸ³è™•ç†æµç¨‹

```
1. ç”¨æˆ¶éŒ„è£½èªéŸ³ (voice_input_screen.dart)
   â†“
2. VoiceService éŒ„è£½éŸ³è¨Š
   - Web: WAV æ ¼å¼å­˜åœ¨è¨˜æ†¶é«” (Uint8List)
   - Mobile: AAC-LC æ ¼å¼å­˜åˆ°æš«å­˜æª”
   â†“
3. ä¸Šå‚³åˆ° Firebase Storage (voice_recordings/{userId}/{timestamp})
   â†“
4. å»ºç«‹ voiceProcessing æ–‡æª” (status: "processing")
   â†“
5. Firestore è§¸ç™¼å™¨ â†’ Cloud Function (voiceHandler.ts)
   â†“
6. Function å‘¼å« Zeabur API: POST /api/voice/parse
   â†“
7. Zeabur è™•ç†æµç¨‹:
   - Whisper: éŸ³è¨Š â†’ ä¸­æ–‡æ–‡å­—è½‰éŒ„
   - GPT-4: æ–‡å­— â†’ çµæ§‹åŒ– JSON (æ¨™é¡Œã€æ™‚é–“ã€åœ°é»ç­‰)
   - NLP (spaCy + dateparser): å¯¦é«”æå–èˆ‡é©—è­‰
   â†“
8. Function å»ºç«‹ events æ–‡æª”
   â†“
9. Function æ›´æ–° voiceProcessing (status: "completed")
   â†“
10. VoiceController é€é StreamProvider ç›£è½ voiceProcessing
    â†“
11. è‡ªå‹•å‘¼å« EventController.createEvent() å»ºç«‹è¡Œç¨‹
    â†“
12. ç”¨æˆ¶åœ¨è¡Œäº‹æ›†ä¸­çœ‹åˆ°æ–°è¡Œç¨‹
```

### é—œéµæª”æ¡ˆèˆ‡è·è²¬

**Flutter App:**
- `lib/providers/`: æ‰€æœ‰ Riverpod providers å’Œ controllers
  - `auth_provider.dart`: èªè­‰ç‹€æ…‹ + ç”¨æˆ¶è³‡æ–™ä¸²æµ
  - `event_provider.dart`: Event CRUD + ç¯©é¸é‚è¼¯
  - `voice_provider.dart`: éŒ„éŸ³ç‹€æ…‹ + è™•ç†ç‹€æ…‹
- `lib/services/firebase_service.dart`: æ‰€æœ‰ Firebase æ“ä½œ (Firestore, Auth, Storage)
- `lib/services/voice_service.dart`: è·¨å¹³å°éŸ³è¨ŠéŒ„è£½
- `lib/models/`: é ˜åŸŸæ¨¡å‹èˆ‡ Firestore åºåˆ—åŒ–
  - `calendar_event.dart`: Event æ¨¡å‹ + EventMetadata (è¿½è¹¤æ˜¯å¦ç‚ºèªéŸ³å»ºç«‹)
  - `voice_processing_record.dart`: AI è™•ç†ç‹€æ…‹è¿½è¹¤
  - `calendar_model.dart`: å¤šè¡Œäº‹æ›†æ”¯æ´

**Firebase Functions:**
- `functions/src/voiceHandler.ts`: ç›£è½ voiceProcessing collection onCreateï¼Œå‘¼å« Zeabur API
- `functions/src/notificationHandler.ts`: ç™¼é€ FCM é€šçŸ¥æé†’è¡Œç¨‹

**Zeabur API:**
- `app/routes/voice.py`: POST /api/voice/parse ç«¯é»
- `app/services/whisper_service.py`: OpenAI Whisper è½‰éŒ„
- `app/services/gpt_service.py`: GPT-4 è¡Œç¨‹è§£æï¼ˆé‡å°ä¸­æ–‡æ—¥æœŸ/æ™‚é–“çš„è©³ç´°æç¤ºå·¥ç¨‹ï¼‰
- `app/services/nlp_service.py`: spaCy å¯¦é«”æå– + dateparser è™•ç†ç›¸å°æ™‚é–“

## è³‡æ–™æ¨¡å‹èˆ‡ Firestore Schema

### Collections

**events/{eventId}**
- `userId`, `calendarId?`, `title`, `startTime`, `endTime`, `location?`, `description?`
- `participants[]`, `reminderMinutes`, `isAllDay`, `labelId?`
- `metadata`: `{createdBy: "voice"|"manual", originalVoiceText?, voiceFileUrl?}`

**voiceProcessing/{processId}**
- `userId`, `audioUrl`, `status` ("processing" | "completed" | "failed")
- `transcription?`, `result?` (VoiceProcessingResult), `eventId?`, `errorMessage?`

**users/{userId}**
- `email`, `displayName`, `photoURL?`, `fcmToken?`, `settings`

**calendars/{calendarId}**
- `ownerId`, `name`, `colorValue`, `isDefault`

**memos/{memoId}**
- `userId`, `title`, `content?`, `isCompleted`, `isPinned`, `priority`

### å®‰å…¨è¦å‰‡ (firestore.rules)

- ç”¨æˆ¶åªèƒ½è®€å¯«è‡ªå·±çš„è³‡æ–™ï¼ˆé€é `request.auth.uid == userId` é©—è­‰ï¼‰
- å»ºç«‹æ™‚å¼·åˆ¶è¦æ±‚å¿…å¡«æ¬„ä½ï¼ˆä¾‹å¦‚ï¼ševents å¿…é ˆæœ‰ title, startTime, endTimeï¼‰
- `userId`/`ownerId` å’Œ `createdAt` åœ¨å»ºç«‹å¾Œä¸å¯è®Šæ›´
- voiceProcessing collection: Cloud Functions å¯é€é service account æ›´æ–° (`request.auth == null`)

## é‡è¦æ¨¡å¼

### è·¨å¹³å°éŸ³è¨ŠéŒ„è£½

```dart
// VoiceService ä¸­çš„å¹³å°ç‰¹å®šè™•ç†
if (kIsWeb) {
  // Web: åœ¨è¨˜æ†¶é«”ä¸­éŒ„è£½ WAVï¼Œç›´æ¥ä¸Šå‚³ bytes
  final bytes = await record.stop();
  await firebaseService.uploadVoiceFile(bytes: bytes);
} else {
  // Mobile: éŒ„è£½åˆ°æª”æ¡ˆï¼Œä¸Šå‚³æª”æ¡ˆ
  final path = await record.stop();
  await firebaseService.uploadVoiceFile(filePath: path);
}
```

### Firestore å³æ™‚åŒæ­¥æ¨¡å¼

æ‰€æœ‰è³‡æ–™ providers ä½¿ç”¨ `StreamProvider` é€²è¡Œå³æ™‚æ›´æ–°ï¼š

```dart
final allEventsProvider = StreamProvider<List<CalendarEvent>>((ref) {
  final userId = ref.watch(currentUserIdProvider);
  if (userId == null) return Stream.value([]);
  return ref.read(firebaseServiceProvider).watchUserEvents(userId);
});
```

### Service å–®ä¾‹æ¨¡å¼

```dart
class FirebaseService {
  static final FirebaseService _instance = FirebaseService._internal();
  factory FirebaseService() => _instance;
  FirebaseService._internal();

  // æ‰€æœ‰ Firebase æ“ä½œ...
}
```

### Controller ç‹€æ…‹è®Šæ›´

```dart
class EventController extends StateNotifier<EventState> {
  final FirebaseService _firebaseService;

  Future<void> createEvent(CalendarEvent event) async {
    state = state.copyWith(isLoading: true);
    try {
      await _firebaseService.createEvent(event);
      state = state.copyWith(isLoading: false);
    } catch (e) {
      state = state.copyWith(isLoading: false, error: e.toString());
    }
  }
}
```

## ç’°å¢ƒé…ç½®

### Firebase è¨­å®šï¼ˆå¿…è¦ï¼‰

1. åœ¨ https://console.firebase.google.com å»ºç«‹ Firebase å°ˆæ¡ˆ
2. æ–°å¢ Flutter æ‡‰ç”¨ç¨‹å¼ (iOS/Android/Web) ä¸¦ä¸‹è¼‰è¨­å®šæª”ï¼š
   - `google-services.json` â†’ `flutter_app/android/app/`
   - `GoogleService-Info.plist` â†’ `flutter_app/ios/Runner/`
   - ä½¿ç”¨ FlutterFire CLI ç”¢ç”Ÿ `firebase_options.dart`
3. å•Ÿç”¨ Authentication (Email/Password, Google, Apple)
4. å»ºç«‹ Firestore è³‡æ–™åº« (production mode)
5. è¨­å®š Storage bucket

### Firebase Functions ç’°å¢ƒè®Šæ•¸

```bash
cd firebase/functions
firebase functions:config:set zeabur.api_url="https://your-api.zeabur.app"
```

æˆ–ä½¿ç”¨ `.env` æª”æ¡ˆï¼ˆæ¨¡æ“¬å™¨ç”¨ï¼‰ï¼š
```
ZEABUR_API_URL=http://localhost:8000
```

### Zeabur API ç’°å¢ƒè®Šæ•¸ (.env)

```bash
OPENAI_API_KEY=sk-...
ENVIRONMENT=production
ALLOWED_ORIGINS=https://your-app.firebaseapp.com
```

### Flutter ç’°å¢ƒå¸¸æ•¸

æ›´æ–° `lib/services/firebase_service.dart` æˆ–å»ºç«‹è¨­å®šæª”ï¼š
```dart
static const String zeaburApiUrl = 'https://your-api.zeabur.app';
```

## æœ¬åœ°æ¸¬è©¦èªéŸ³åŠŸèƒ½

1. å•Ÿå‹• Zeabur APIï¼š
   ```bash
   cd zeabur_api
   uvicorn app.main:app --reload
   ```

2. å•Ÿå‹• Firebase Emulatorsï¼š
   ```bash
   cd firebase
   firebase emulators:start
   ```

3. æ›´æ–° Flutter app ä½¿ç”¨æ¨¡æ“¬å™¨ï¼ˆåŠ åˆ° main.dartï¼‰ï¼š
   ```dart
   await Firebase.initializeApp();
   if (kDebugMode) {
     FirebaseFirestore.instance.useFirestoreEmulator('localhost', 8080);
     FirebaseStorage.instance.useStorageEmulator('localhost', 9199);
     await FirebaseAuth.instance.useAuthEmulator('localhost', 9099);
   }
   ```

4. åŸ·è¡Œ Flutter appï¼š
   ```bash
   cd flutter_app
   flutter run
   ```

## éƒ¨ç½²èªªæ˜

### Firebase Functions éƒ¨ç½²

```bash
cd firebase
firebase deploy --only functions
```

æ³¨æ„ï¼šéœ€ä½¿ç”¨ Node.js ç‰ˆæœ¬ 22ï¼ˆåœ¨ package.json engines ä¸­æŒ‡å®šï¼‰ã€‚

### Zeabur API éƒ¨ç½²

1. é€£æ¥ GitHub repo åˆ° Zeabur
2. Zeabur è‡ªå‹•åµæ¸¬ zeabur_api/ ä¸­çš„ Dockerfile
3. åœ¨ Zeabur dashboard è¨­å®šç’°å¢ƒè®Šæ•¸
4. git push æ™‚è‡ªå‹•è§¸ç™¼éƒ¨ç½²

é‡è¦ï¼šspaCy æ¨¡å‹ (zh_core_web_sm) åœ¨ Docker build æ™‚ä¸‹è¼‰ï¼ˆè¦‹ Dockerfile ç¬¬ 20 è¡Œï¼‰ã€‚

### Flutter App éƒ¨ç½²

**Web:**
```bash
flutter build web
# éƒ¨ç½²åˆ° Firebase Hosting æˆ–å…¶ä»–éœæ…‹è¨—ç®¡
```

**Mobile:**
- iOS: é€é Xcode å»ºç½®ï¼Œä¸Šå‚³åˆ° App Store Connect
- Android: å»ºç½® APK/AABï¼Œä¸Šå‚³åˆ° Google Play Console

## å¤šè¡Œäº‹æ›†æ¶æ§‹

æ”¯æ´æ¯ä½ç”¨æˆ¶å»ºç«‹å¤šå€‹è¡Œäº‹æ›†ï¼š

- **èˆŠç‰ˆè¡Œç¨‹**ï¼šæ²’æœ‰ `calendarId` çš„è¡Œç¨‹æœƒé¡¯ç¤ºåœ¨ç¬¬ä¸€å€‹å¯ç”¨çš„è¡Œäº‹æ›†
- **é è¨­è¡Œäº‹æ›†**ï¼šé¦–æ¬¡å•Ÿå‹•æ™‚è‡ªå‹•å»ºç«‹ (`isDefault: true`)
- **è¡Œäº‹æ›†é¡è‰²**ï¼šå„²å­˜ç‚º `colorValue` (Color çš„æ•´æ•¸è¡¨ç¤º)
- **åˆªé™¤**ï¼šåˆªé™¤è¡Œäº‹æ›†æ™‚ï¼Œå…¶ä¸‹æ‰€æœ‰è¡Œç¨‹éƒ½æœƒè¢«åˆªé™¤ï¼ˆæ‰¹æ¬¡æ“ä½œï¼‰

## è¡Œç¨‹æ¨™ç±¤

12 ç¨®é å®šç¾©æ¨™ç±¤é¡å‹ (EventLabelType enum)ï¼š
- work, personal, meeting, birthday, appointment, study, exercise, travel, reminder, other, holiday, family

æ¨™ç±¤å„²å­˜åœ¨ `events.labelId`ï¼ˆé¸å¡«æ¬„ä½ï¼‰ã€‚

## é€šçŸ¥ç³»çµ±

**ç›®å‰å¯¦ä½œï¼š**
- `notificationHandler.ts` ç›£è½è¡Œç¨‹å»ºç«‹
- å¦‚æœæé†’æ™‚é–“å·²éï¼Œç«‹å³ç™¼é€ FCM é€šçŸ¥
- ä½¿ç”¨ users collection ä¸­çš„ `fcmToken`

**é™åˆ¶ï¼š**
- æ’ç¨‹æœªä¾†é€šçŸ¥éœ€è¦ Cloud Schedulerï¼ˆå°šæœªå¯¦ä½œï¼‰
- æ­£å¼ç’°å¢ƒéœ€æ•´åˆ Cloud Tasks æˆ– Cloud Schedulerï¼Œåœ¨ `startTime - reminderMinutes` æ™‚è§¸ç™¼é€šçŸ¥

## å¸¸è¦‹é™¤éŒ¯

### èªéŸ³è™•ç†å¡ä½

ä¾åºæª¢æŸ¥ï¼š
1. Firestore: voiceProcessing æ–‡æª”çš„ status ("processing" vs "completed")
2. Cloud Functions æ—¥èªŒ: `firebase functions:log`
3. Zeabur API æ—¥èªŒ: æª¢æŸ¥ Zeabur dashboard æˆ–å®¹å™¨æ—¥èªŒ
4. é©—è­‰ Cloud Functions ä¸­çš„ ZEABUR_API_URL ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®š

### Firestore æ¬Šé™éŒ¯èª¤

æª¢æŸ¥ï¼š
1. ç”¨æˆ¶å·²èªè­‰ (`currentUserIdProvider` ä¸æ˜¯ null)
2. æ–‡æª”çš„ `userId` ç¬¦åˆ `request.auth.uid`
3. å¿…å¡«æ¬„ä½å­˜åœ¨ï¼ˆè¦‹ firestore.rules é©—è­‰ï¼‰

### éŸ³è¨ŠéŒ„è£½å¤±æ•—

æª¢æŸ¥ï¼š
1. éº¥å…‹é¢¨æ¬Šé™å·²æˆäºˆï¼ˆiOS Info.plist, Android manifestï¼‰
2. å¹³å°ï¼š`kIsWeb` é‚è¼¯æ­£ç¢ºè™•ç† Web vs Mobile
3. Record package åˆå§‹åŒ–ï¼š`await record.hasPermission()`

## GPT æç¤ºå·¥ç¨‹æ³¨æ„äº‹é …

GPT æœå‹™ä½¿ç”¨ temperature 0.3 å’Œè©³ç´°çš„ç³»çµ±æç¤ºï¼ˆè¦‹ `zeabur_api/app/services/gpt_service.py`ï¼‰ï¼š

- è™•ç†ä¸­æ–‡ç›¸å°æ—¥æœŸï¼šã€Œæ˜å¤©ã€â†’ æ˜å¤©çš„æ—¥æœŸã€ã€Œä¸‹é€±ä¸€ã€â†’ ä¸‹é€±ä¸€
- æ™‚æ®µé—œéµå­—ï¼šã€Œæ—©ä¸Šã€â†’ 09:00ã€ã€Œä¸‹åˆã€â†’ 14:00ã€ã€Œæ™šä¸Šã€â†’ 19:00
- é è¨­æ™‚é•·ï¼šè‹¥æœªæŒ‡å®šå‰‡ç‚º 1 å°æ™‚
- å…¨å¤©è¡Œç¨‹ï¼šåµæ¸¬é—œéµå­—å¦‚ã€Œå…¨å¤©ã€ã€ã€Œæ•´å¤©ã€
- è¦æ±‚ ISO 8601 è¼¸å‡ºæ ¼å¼

è‹¥è¦æå‡æº–ç¢ºåº¦ï¼Œä¿®æ”¹ `gpt_service.py` ä¸­çš„ç³»çµ±æç¤ºã€‚

## æˆæœ¬å„ªåŒ–

ç›®å‰è¨­å®šï¼ˆæ¯ 1000 æ¬¡èªéŸ³è¡Œç¨‹ï¼‰ï¼š
- Whisper API: ~$3 (å¹³å‡ 30 ç§’ Ã— $0.006/åˆ†é˜)
- GPT-4: ~$5 (å‡è¨­å¹³å‡ 500 tokens Ã— $0.03/1K tokens)

**é™ä½æˆæœ¬æ–¹æ³•ï¼š**
1. åœ¨ `gpt_service.py` ä¸­æ”¹ç”¨ GPT-3.5-turboï¼ˆä¾¿å®œ 90%ï¼‰ï¼š
   ```python
   model="gpt-3.5-turbo"  # instead of gpt-4
   ```
2. è€ƒæ…®æœ¬åœ°éƒ¨ç½² Whisper (faster-whisper)
3. åŠ å…¥çµæœå¿«å–æ©Ÿåˆ¶ï¼ˆç›¸åŒè½‰éŒ„çµæœï¼‰
4. é™åˆ¶æ¯ä½ç”¨æˆ¶çš„èªéŸ³è¡Œç¨‹æ¬¡æ•¸

## å·²çŸ¥é™åˆ¶

1. **æ’ç¨‹é€šçŸ¥**ï¼šéœ€è¦ Cloud Scheduler æ•´åˆï¼ˆå°šæœªå¯¦ä½œï¼‰
2. **é€±æœŸæ€§è¡Œç¨‹**ï¼šå°šä¸æ”¯æ´é‡è¤‡è¡Œç¨‹ï¼ˆæ¯æ—¥/æ¯é€±/æ¯æœˆï¼‰
3. **è¡Œç¨‹åˆ†äº«**ï¼šå°šç„¡å¤šäººå”ä½œåŠŸèƒ½
4. **é›¢ç·šæ¨¡å¼**ï¼šç„¡æœ¬åœ°å¿«å–ï¼Œéœ€è¦ç¶²è·¯é€£ç·š
5. **è¡Œäº‹æ›†åŒ¯å…¥/åŒ¯å‡º**ï¼šå°šä¸æ”¯æ´ iCal
6. **èªéŸ³ç·¨è¼¯**ï¼šç„¡æ³•ç”¨èªéŸ³ç·¨è¼¯ç¾æœ‰è¡Œç¨‹ï¼ˆåƒ…èƒ½å»ºç«‹ï¼‰
