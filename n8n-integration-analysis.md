# AI Calendar App - n8n 整合分析

> 本文件分析 AI Calendar App 可運用 n8n 自動化工作流程的場景、優劣勢及成本考量。

## 目錄

- [目前架構概述](#目前架構概述)
- [可運用 n8n 的場景](#可運用-n8n-的場景)
  - [1. 語音處理工作流程](#1-語音處理工作流程最適合)
  - [2. 通知排程系統](#2-通知排程系統)
  - [3. 第三方日曆同步](#3-第三方日曆同步)
  - [4. 資料備份與匯出](#4-資料備份與匯出)
- [成本比較](#成本比較)
- [導入優先順序建議](#導入優先順序建議)
- [不建議使用 n8n 的部分](#不建議使用-n8n-的部分)
- [結論](#結論)

---

## 目前架構概述

```
Flutter App (Mobile/Web)
    ↓ Firebase SDK
Firebase Backend (Firestore + Storage + Functions)
    ↓ HTTP
Zeabur API (FastAPI Python) → OpenAI APIs
```

### 主要工作流程

1. **語音處理**：用戶錄音 → Cloud Function → Zeabur API (Whisper + GPT) → 建立行程
2. **通知系統**：行程建立 → FCM 通知（排程通知尚未實作）
3. **資料同步**：Firestore Streams 即時同步

---

## 可運用 n8n 的場景

### 1. 語音處理工作流程（最適合）

#### 目前架構

```
Firestore Trigger → Cloud Function → Zeabur API (Whisper + GPT) → 建立行程
```

#### n8n 替代方案

```
Firestore Trigger Node → OpenAI Whisper Node → OpenAI GPT Node → Firestore Node
```

#### 比較分析

| 面向 | 目前架構 | n8n 方案 |
|------|----------|----------|
| **優勢** | 低延遲、整合緊密 | 可視化流程、易於調整、無需維護 Zeabur API |
| **劣勢** | 需維護兩套服務（Functions + Zeabur） | 額外延遲、多一個服務依賴 |
| **成本** | Zeabur ~$5/月 + Functions 執行費 | n8n Cloud ~$20/月 或自託管免費 |

#### 為什麼 n8n 更好

- 可以**省去整個 Zeabur API 服務**，直接在 n8n 內呼叫 OpenAI
- 流程修改只需拖拉節點，不用改程式碼部署
- 錯誤處理、重試機制內建
- 可輕鬆加入額外步驟（如：發送確認通知、記錄日誌）

#### n8n 工作流程設計

```
┌─────────────────┐
│ Firestore       │
│ Trigger         │
│ (voiceProcessing│
│  collection)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│ HTTP Request    │
│ (下載音訊檔案)   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ OpenAI          │
│ (Whisper 轉錄)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│ OpenAI          │
│ (GPT-4 解析)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Firestore       │
│ (建立 event)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Firestore       │
│ (更新狀態)      │
└─────────────────┘
```

---

### 2. 通知排程系統

#### 目前限制

- 排程未來通知需要 Cloud Scheduler（尚未實作）
- 只有在行程建立時，若提醒時間已過才發送通知

#### n8n 解決方案

```
Schedule Trigger (每分鐘) → 查詢即將到期行程 → 發送 FCM/Email/LINE 通知
```

#### 比較分析

| 面向 | Cloud Scheduler | n8n 方案 |
|------|-----------------|----------|
| **優勢** | GCP 原生整合 | 多通道通知、可視化管理 |
| **劣勢** | 只能觸發 Functions、需寫 cron | 需額外服務 |
| **成本** | ~$0.10/job/月 | 包含在 n8n 訂閱內 |

#### 為什麼 n8n 更好

- 內建 300+ 整合，可輕鬆加入多種通知管道：
  - LINE Notify
  - Telegram Bot
  - Slack
  - Email (SMTP/Gmail/Outlook)
  - SMS (Twilio)
- 排程介面直覺，不需寫 cron 表達式
- 可根據行程類型發送不同格式的通知

#### n8n 工作流程設計

```
┌─────────────────┐
│ Schedule        │
│ Trigger         │
│ (每分鐘執行)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Firestore       │
│ (查詢即將到期   │
│  的行程)        │
└────────┬────────┘
         ↓
┌─────────────────┐
│ IF              │
│ (有需要通知的   │
│  行程？)        │
└────────┬────────┘
         ↓
    ┌────┴────┐
    ↓         ↓
┌───────┐ ┌───────┐
│ FCM   │ │ LINE  │
│ Push  │ │Notify │
└───────┘ └───────┘
```

---

### 3. 第三方日曆同步

#### 目前限制

- 不支援 iCal 匯入/匯出
- 無法與 Google Calendar、Outlook 等同步

#### n8n 可實現

**雙向同步：**
```
Google Calendar Trigger → 同步到 Firestore
Firestore Trigger → 同步到 Google/Outlook Calendar
```

#### 比較分析

| 面向 | 自行開發 | n8n 方案 |
|------|----------|----------|
| **開發時間** | 2-3 週 | 2-3 小時 |
| **維護成本** | 需處理 OAuth、API 變更 | n8n 維護整合 |
| **支援平台** | 需逐一開發 | 現成節點 |

#### 為什麼 n8n 更好

- Google Calendar、Outlook、Apple Calendar 節點都是現成的
- OAuth 流程內建處理，無需自行實作
- 可輕鬆支援多個日曆平台

#### n8n 工作流程設計

**從 Google Calendar 同步到 App：**
```
┌─────────────────┐
│ Google Calendar │
│ Trigger         │
│ (新增/修改事件) │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 資料轉換        │
│ (格式對應)      │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Firestore       │
│ (建立/更新      │
│  event)         │
└─────────────────┘
```

**從 App 同步到 Google Calendar：**
```
┌─────────────────┐
│ Firestore       │
│ Trigger         │
│ (events 變更)   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 資料轉換        │
│ (格式對應)      │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Google Calendar │
│ (建立/更新      │
│  event)         │
└─────────────────┘
```

---

### 4. 資料備份與匯出

#### n8n 可實現

**定期備份：**
```
每週排程 → 匯出 Firestore 資料 → 存到 Google Drive/Dropbox
```

**用戶匯出請求：**
```
Webhook Trigger → 查詢用戶資料 → 產生 CSV/JSON → 發送 Email
```

#### n8n 工作流程設計

```
┌─────────────────┐
│ Schedule        │
│ Trigger         │
│ (每週日 02:00)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Firestore       │
│ (匯出所有資料)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│ JSON/CSV        │
│ 轉換            │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Google Drive    │
│ (上傳備份檔)    │
└─────────────────┘
```

---

## 成本比較

### 月成本估算

| 方案 | 月成本 | 說明 |
|------|--------|------|
| **目前架構** | ~$7/月 | Zeabur $5 + Cloud Functions ~$2 |
| **n8n Cloud Starter** | $20/月 | 2,500 次執行/月 |
| **n8n Cloud Pro** | $50/月 | 10,000 次執行/月 |
| **n8n 自託管** | $5/月 | VPS 費用（如 DigitalOcean Droplet） |
| **混合方案** | ~$12/月 | 保留 Functions + n8n 自託管 |

### n8n 版本比較

| 特性 | n8n Cloud | n8n Self-host |
|------|-----------|---------------|
| **設定難度** | 簡單（註冊即用） | 中等（需架設伺服器） |
| **維護成本** | 無 | 需自行維護更新 |
| **執行次數限制** | 依方案 | 無限制 |
| **資料隱私** | 資料在 n8n 伺服器 | 完全自控 |
| **適合對象** | 新手、小型團隊 | 技術能力足夠、注重隱私 |

### 成本效益分析

如果只是要解決**通知排程**和**日曆同步**：
- n8n Cloud Starter ($20/月) 足夠使用
- 或 n8n 自託管 ($5/月 VPS) 更經濟

如果要**取代 Zeabur API**：
- 省下 Zeabur $5/月
- 但 n8n Cloud 可能需要 Pro 方案 ($50/月) 處理較多語音請求
- 自託管方案較划算

---

## 導入優先順序建議

### 第一優先：通知排程系統

| 項目 | 說明 |
|------|------|
| **風險** | 低 - 不影響現有架構 |
| **價值** | 高 - 解決目前「排程通知未實作」的限制 |
| **實作時間** | 2-3 小時 |
| **依賴** | 無 |

### 第二優先：第三方日曆同步

| 項目 | 說明 |
|------|------|
| **風險** | 低 - 新增功能 |
| **價值** | 高 - 用戶常見需求 |
| **實作時間** | 3-4 小時 |
| **依賴** | 需用戶授權 Google/Outlook 帳號 |

### 第三優先：語音處理流程

| 項目 | 說明 |
|------|------|
| **風險** | 中 - 需測試延遲是否可接受 |
| **價值** | 高 - 可省去 Zeabur API 維護 |
| **實作時間** | 4-6 小時 |
| **依賴** | 需驗證 n8n 處理速度 |

### 第四優先：資料備份

| 項目 | 說明 |
|------|------|
| **風險** | 低 |
| **價值** | 中 |
| **實作時間** | 1-2 小時 |
| **依賴** | 需決定備份存放位置 |

---

## 不建議使用 n8n 的部分

| 功能 | 原因 |
|------|------|
| **即時資料同步** | Firestore Streams 延遲更低、更穩定 |
| **用戶認證** | Firebase Auth 已足夠完善，無需額外處理 |
| **核心 CRUD 操作** | 直接用 Firebase SDK 更高效 |
| **UI 互動邏輯** | 應在 Flutter App 端處理 |

---

## 結論

### n8n 最適合用於

1. **補足目前架構缺失的功能**
   - 排程通知
   - 日曆同步
   - 資料備份

2. **簡化後端服務數量**
   - 可能取代 Zeabur API
   - 減少維護負擔

3. **快速實驗新功能**
   - 無需部署程式碼
   - 可視化調整流程

### 建議行動

1. 先從**通知排程**開始試用 n8n Cloud 免費版
2. 評估延遲和穩定性
3. 若效果良好，再考慮擴展到其他場景
4. 長期可考慮自託管以降低成本

### 相關資源

- [n8n 官方文件](https://docs.n8n.io/)
- [n8n Cloud 方案](https://n8n.io/pricing/)
- [n8n Firestore Node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.firestore/)
- [n8n OpenAI Node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.openai/)
