"""
GPT èªæ„è§£ææœå‹™

ä½¿ç”¨ OpenAI GPT API å°‡å£èªåŒ–æ–‡å­—è§£æç‚ºçµæ§‹åŒ–è¡Œç¨‹è³‡æ–™
"""

import os
import json
from openai import OpenAI
from loguru import logger
from datetime import datetime, timedelta
from typing import Dict, Any, List, Optional

class GPTService:
    """GPT èªæ„è§£ææœå‹™é¡åˆ¥"""
    
    def __init__(self):
        """åˆå§‹åŒ–æœå‹™"""
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("æœªè¨­å®š OPENAI_API_KEY ç’°å¢ƒè®Šæ•¸")

        self.client = OpenAI(api_key=api_key)

    def _get_weekday_chinese(self, dt: datetime) -> str:
        """å°‡æ—¥æœŸè½‰æ›ç‚ºä¸­æ–‡æ˜ŸæœŸ"""
        weekdays = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"]
        return weekdays[dt.weekday()]
    
    def _build_label_prompt(self, labels: Optional[List[Dict[str, str]]]) -> str:
        """
        å»ºç«‹æ¨™ç±¤æ¨æ–·çš„ prompt ç‰‡æ®µ

        Args:
            labels: æ¨™ç±¤åˆ—è¡¨ï¼Œæ¯å€‹æ¨™ç±¤åŒ…å« id å’Œ name

        Returns:
            æ¨™ç±¤æ¨æ–·è¦å‰‡çš„ prompt å­—ä¸²
        """
        if not labels or len(labels) == 0:
            return ""

        prompt = """
9. **æ¨™ç±¤æ¨æ–·**ï¼ˆæ¥µç‚ºé‡è¦ï¼å¿…é ˆèªçœŸæ¨æ–·ä¸¦è¼¸å‡º labelId æ¬„ä½ï¼‰ï¼š
   ä½ å¿…é ˆæ ¹æ“šè¡Œç¨‹å…§å®¹ï¼Œå¾ä»¥ä¸‹æ¨™ç±¤åˆ—è¡¨ä¸­é¸æ“‡æœ€é©åˆçš„æ¨™ç±¤ IDã€‚
   é€™æ˜¯ç”¨æˆ¶è¡Œç¨‹ç®¡ç†çš„é‡è¦åŠŸèƒ½ï¼Œè«‹å‹™å¿…èªçœŸæ¨æ–·ï¼

   å¯ç”¨æ¨™ç±¤åˆ—è¡¨ï¼š
"""
        for label in labels:
            label_id = label.get('id', '')
            label_name = label.get('name', '')
            prompt += f"   - {label_id}ï¼š{label_name}\n"

        prompt += """
   æ¨™ç±¤åŒ¹é…è¦å‰‡ï¼ˆè«‹åš´æ ¼éµå®ˆï¼‰ï¼š

   ã€å·¥ä½œ/æœƒè­°é¡ã€‘â†’ å„ªå…ˆé¸æ“‡ã€Œæœƒè­°ã€æ¨™ç±¤ï¼Œå…¶æ¬¡é¸ã€Œå·¥ä½œã€æ¨™ç±¤
   é—œéµå­—ï¼šé–‹æœƒã€æœƒè­°ã€è¨è«–ã€å ±å‘Šã€å®¢æˆ¶ã€å°ˆæ¡ˆã€å·¥ä½œã€ç°¡å ±ã€ææ¡ˆã€reviewã€syncã€é¢è©¦ã€åŸ¹è¨“

   ã€å®¶åº­é¡ã€‘â†’ é¸æ“‡ã€Œå®¶åº­ã€æ¨™ç±¤
   é—œéµå­—ï¼šçˆ¸åª½ã€åª½åª½ã€çˆ¸çˆ¸ã€å®¶äººã€è¦ªæˆšã€å®¶è£¡ã€å®¶åº­èšæœƒã€æ¢è¦ª

   ã€å­¸ç¿’é¡ã€‘â†’ é¸æ“‡ã€Œå­¸ç¿’ã€æ¨™ç±¤
   é—œéµå­—ï¼šè®€æ›¸ã€ä¸Šèª²ã€è€ƒè©¦ã€ä½œæ¥­ã€å­¸ç¿’ã€è£œç¿’ã€åŸ¹è¨“èª²ç¨‹ã€è¬›åº§

   ã€é‹å‹•é¡ã€‘â†’ é¸æ“‡ã€Œé‹å‹•ã€æ¨™ç±¤
   é—œéµå­—ï¼šå¥èº«ã€è·‘æ­¥ã€æ¸¸æ³³ã€çƒé¡ã€é‹å‹•ã€ç‘œçˆã€ç±ƒçƒã€ç¾½çƒã€ç¶²çƒã€ç™»å±±ã€å¥èµ°

   ã€ä¼‘é–’é¡ã€‘â†’ é¸æ“‡ã€Œä¼‘é–’ã€æ¨™ç±¤
   é—œéµå­—ï¼šçœ‹é›»å½±ã€åƒé£¯ã€èšé¤ã€ç©æ¨‚ã€ä¼‘æ¯ã€å¨›æ¨‚ã€é€›è¡—ã€è³¼ç‰©ã€ä¸‹åˆèŒ¶ã€å–å’–å•¡

   ã€ç´„æœƒé¡ã€‘â†’ é¸æ“‡ã€Œç´„æœƒã€æ¨™ç±¤
   é—œéµå­—ï¼šç´„æœƒã€æƒ…ä¾¶ã€ç”·å¥³æœ‹å‹ã€è€å…¬ã€è€å©†ã€å¦ä¸€åŠ

   ã€æ—…è¡Œé¡ã€‘â†’ é¸æ“‡ã€Œæ—…è¡Œã€æ¨™ç±¤
   é—œéµå­—ï¼šå‡ºå·®ã€æ—…éŠã€å‡ºåœ‹ã€æ—…è¡Œã€é£›æ©Ÿã€æ©Ÿå ´ã€ä½å®¿ã€è¨‚æˆ¿

   ã€å€‹äººé¡ã€‘â†’ é¸æ“‡ã€Œå€‹äººã€æ¨™ç±¤
   é—œéµå­—ï¼šç”Ÿæ—¥ã€æ…¶ç¥ã€ç´€å¿µæ—¥ã€é«”æª¢ã€çœ‹é†«ç”Ÿã€ç‰™é†«ã€ç¾å®¹ã€ç¾é«®

   ã€é‡è¦/ç·Šæ€¥é¡ã€‘â†’ é¸æ“‡ã€Œé‡è¦ã€æ¨™ç±¤
   é—œéµå­—ï¼šé‡è¦ã€ç·Šæ€¥ã€æˆªæ­¢æ—¥ã€deadlineã€å¿…é ˆã€ä¸€å®šè¦

   ã€ç¤¾äº¤é¡ã€‘â†’ é¸æ“‡ã€Œç¤¾äº¤ã€æ¨™ç±¤
   é—œéµå­—ï¼šæœ‹å‹ã€åŒå­¸ã€èšæœƒã€æ´¾å°ã€partyã€æ…¶åŠŸã€æ­¡é€ã€æ­¡è¿

   âš ï¸ é‡è¦è¦å‰‡ï¼š
   1. åªè¦è¡Œç¨‹å…§å®¹åŒ…å«ä¸Šè¿°ä»»ä½•é—œéµå­—ï¼Œå°±å¿…é ˆé¸æ“‡å°æ‡‰çš„æ¨™ç±¤
   2. å¦‚æœåŒæ™‚ç¬¦åˆå¤šå€‹é¡åˆ¥ï¼Œé¸æ“‡æœ€ä¸»è¦çš„é‚£å€‹ï¼ˆä¾‹å¦‚ã€Œè·ŸåŒäº‹é–‹æœƒã€é¸ã€Œæœƒè­°ã€è€Œéã€Œç¤¾äº¤ã€ï¼‰
   3. labelId å¿…é ˆæ˜¯ä¸Šé¢åˆ—è¡¨ä¸­çš„ IDï¼ˆå¦‚ label_1ã€label_6 ç­‰ï¼‰ï¼Œçµ•å°ä¸èƒ½è‡ªå·±ç·¨é€ 
   4. åªæœ‰åœ¨å®Œå…¨ç„¡æ³•åˆ¤æ–·é¡åˆ¥æ™‚ï¼Œæ‰å°‡ labelId è¨­ç‚º null
"""
        return prompt

    def parse_event_from_text(self, text: str, labels: Optional[List[Dict[str, str]]] = None) -> Dict[str, Any]:
        """
        å°‡å£èªåŒ–æ–‡å­—è§£æç‚ºçµæ§‹åŒ–è¡Œç¨‹è³‡æ–™

        Args:
            text: èªéŸ³è½‰æ›çš„æ–‡å­—
            labels: å¯é¸çš„æ¨™ç±¤åˆ—è¡¨ï¼Œç”¨æ–¼ AI è‡ªå‹•é¸æ“‡æ¨™ç±¤

        Returns:
            çµæ§‹åŒ–çš„è¡Œç¨‹è³‡æ–™å­—å…¸

        Raises:
            Exception: è§£æå¤±æ•—æ™‚æ‹‹å‡ºä¾‹å¤–
        """
        try:
            logger.info(f"é–‹å§‹è§£ææ–‡å­—ï¼š{text}")
            if labels and len(labels) > 0:
                logger.info(f"ä½¿ç”¨æ¨™ç±¤åˆ—è¡¨ï¼ˆå…± {len(labels)} å€‹ï¼‰ï¼š")
                for label in labels:
                    logger.info(f"  - {label.get('id')}: {label.get('name')}")
            else:
                logger.warning("æœªæä¾›æ¨™ç±¤åˆ—è¡¨ï¼Œå°‡ç„¡æ³•æ¨æ–· labelId")

            # å–å¾—ç•¶å‰æ—¥æœŸæ™‚é–“ä½œç‚ºåƒè€ƒ
            now = datetime.now()
            current_date = now.strftime("%Y-%m-%d")
            current_time = now.strftime("%H:%M")

            # å»ºç«‹æ¨™ç±¤æ¨æ–· promptï¼ˆå¦‚æœæœ‰æä¾›æ¨™ç±¤ï¼‰
            label_prompt = self._build_label_prompt(labels)

            # å»ºç«‹ç³»çµ±æç¤ºè©
            system_prompt = f"""ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œç¨‹è§£æåŠ©æ‰‹ã€‚
ç”¨æˆ¶æœƒç”¨å£èªåŒ–çš„æ–¹å¼æè¿°è¡Œç¨‹ï¼Œä½ éœ€è¦å°‡å®ƒè½‰æ›æˆ JSON æ ¼å¼ã€‚

ç•¶å‰æ—¥æœŸæ™‚é–“åƒè€ƒï¼š
- æ—¥æœŸï¼š{current_date}ï¼ˆæ˜ŸæœŸ{self._get_weekday_chinese(now)}ï¼‰
- æ™‚é–“ï¼š{current_time}

=== è§£æè¦å‰‡ ===

1. **æ¨™é¡Œæå–**ï¼ˆæœ€é‡è¦ï¼‰ï¼š
   - æå–æ ¸å¿ƒå‹•ä½œæˆ–æ´»å‹•åç¨±ä½œç‚ºæ¨™é¡Œ
   - "å»é¤å»³åƒé£¯" â†’ æ¨™é¡Œï¼š"åƒé£¯"
   - "è·Ÿ Amy é–‹æœƒ" â†’ æ¨™é¡Œï¼š"è·Ÿ Amy é–‹æœƒ"
   - "çœ‹é›»å½±" â†’ æ¨™é¡Œï¼š"çœ‹é›»å½±"
   - "åšå ±å‘Š" â†’ æ¨™é¡Œï¼š"åšå ±å‘Š"
   - "å¥èº«" / "é‹å‹•" â†’ æ¨™é¡Œï¼š"å¥èº«" / "é‹å‹•"
   - æ¨™é¡Œæ‡‰ç°¡æ½”æ˜ç­ï¼Œä¸åŒ…å«æ™‚é–“åœ°é»è³‡è¨Š

2. **æ™‚é–“æ ¼å¼**ï¼šå¿…é ˆä½¿ç”¨ ISO 8601 æ ¼å¼ï¼ˆYYYY-MM-DDTHH:MM:SSï¼‰

3. **æ—¥æœŸæ¨æ–·**ï¼š
   - "ä»Šå¤©" â†’ {current_date}
   - "æ˜å¤©" â†’ ç•¶å‰æ—¥æœŸ + 1 å¤©
   - "å¾Œå¤©" / "å¤§å¾Œå¤©" â†’ ç•¶å‰æ—¥æœŸ + 2/3 å¤©
   - "ä¸‹é€±ä¸€/äºŒ/ä¸‰/å››/äº”/å…­/æ—¥" â†’ è¨ˆç®—ä¸‹é€±å°æ‡‰æ˜ŸæœŸçš„æ—¥æœŸ
   - "é€™é€±X" / "æœ¬é€±X" â†’ è¨ˆç®—æœ¬é€±å°æ‡‰æ˜ŸæœŸçš„æ—¥æœŸ
   - "XæœˆXæ—¥" / "XæœˆXè™Ÿ" â†’ ä½¿ç”¨æŒ‡å®šæ—¥æœŸï¼ˆå¹´ä»½é è¨­ç‚ºç•¶å¹´ï¼Œè‹¥å·²éå‰‡ç‚ºæ˜å¹´ï¼‰
   - "æœˆåº•" â†’ ç•¶æœˆæœ€å¾Œä¸€å¤©
   - "ä¸‹å€‹æœˆXè™Ÿ" â†’ ä¸‹å€‹æœˆå°æ‡‰æ—¥æœŸ

4. **æ™‚é–“æ¨æ–·**ï¼š
   - "æ—©ä¸Š" / "ä¸Šåˆ" â†’ 09:00
   - "ä¸­åˆ" â†’ 12:00
   - "ä¸‹åˆ" â†’ 14:00ï¼ˆè‹¥æœ‰å…·é«”æ™‚é–“å¦‚"ä¸‹åˆ3é»"å‰‡ç‚º 15:00ï¼‰
   - "å‚æ™š" â†’ 17:00
   - "æ™šä¸Š" â†’ 19:00ï¼ˆè‹¥æœ‰å…·é«”æ™‚é–“å¦‚"æ™šä¸Š8é»"å‰‡ç‚º 20:00ï¼‰
   - "å‡Œæ™¨" â†’ 02:00
   - "åŠå¤œ" â†’ 00:00
   - æ•¸å­—æ™‚é–“ï¼š
     - "å…©é»" / "2é»" â†’ æ ¹æ“šä¸Šä¸‹æ–‡åˆ¤æ–· 02:00 æˆ– 14:00ï¼ˆé è¨­ä¸‹åˆï¼‰
     - "ä¸‹åˆ5é»" / "äº”é»" â†’ 17:00
     - "å…©é»åŠ" / "2é»30" â†’ 14:30
     - "ä¸‰é»åäº”" â†’ 15:15
     - "å·®ååˆ†ä¸‰é»" â†’ 14:50

5. **æŒçºŒæ™‚é–“**ï¼š
   - è‹¥æœªæ˜ç¢ºèªªæ˜çµæŸæ™‚é–“ï¼Œé è¨­ç‚ºé–‹å§‹æ™‚é–“ + 1 å°æ™‚
   - "é–‹æœƒå…©å°æ™‚" â†’ çµæŸæ™‚é–“ = é–‹å§‹æ™‚é–“ + 2 å°æ™‚
   - "å…¨å¤©" / "æ•´å¤©" â†’ isAllDay: trueï¼ŒstartTime ç‚º 00:00:00ï¼ŒendTime ç‚º 23:59:59
   - "ä¸€æ•´å€‹ä¸‹åˆ" â†’ 14:00 åˆ° 18:00

6. **åœ°é»æå–**ï¼š
   - "åœ¨XX" â†’ åœ°é»ï¼šXXï¼ˆä¾‹å¦‚ï¼š"åœ¨å’–å•¡å»³" â†’ "å’–å•¡å»³"ï¼‰
   - "å»XX" â†’ åœ°é»ï¼šXXï¼ˆä¾‹å¦‚ï¼š"å»é¤å»³" â†’ "é¤å»³"ï¼‰
   - "åˆ°XX" â†’ åœ°é»ï¼šXX
   - "XXè¦‹" â†’ åœ°é»ï¼šXX
   - å…·é«”åœ°åç›´æ¥æå–ï¼ˆä¾‹å¦‚ï¼š"å°åŒ—101" â†’ "å°åŒ—101"ï¼‰
   - è‹¥ç„¡åœ°é»è³‡è¨Šï¼Œlocation è¨­ç‚ºç©ºå­—ä¸² ""

7. **å‚™è¨» (description)**ï¼š
   - "è¨˜å¾—å¸¶XX" / "è¦å¸¶XX" â†’ å¯«å…¥ description
   - "æ³¨æ„XX" / "åˆ¥å¿˜äº†XX" â†’ å¯«å…¥ description
   - é¡å¤–èªªæ˜è³‡è¨Šå¯«å…¥ description
   - è‹¥ç„¡é¡å¤–è³‡è¨Šï¼Œdescription è¨­ç‚ºç©ºå­—ä¸² ""

8. **åƒèˆ‡è€…**ï¼š
   - "è·ŸXX" / "å’ŒXX" / "èˆ‡XX" â†’ åŠ å…¥ participants
   - å¤šäººç”¨é “è™Ÿæˆ–ã€Œå’Œã€åˆ†éš”ï¼š"è·Ÿ Amy å’Œ Bob" â†’ ["Amy", "Bob"]
   - è‹¥ç„¡åƒèˆ‡è€…ï¼Œparticipants è¨­ç‚ºç©ºé™£åˆ— []
{label_prompt}
=== è§£æç¯„ä¾‹ ===

ç¯„ä¾‹ 1ï¼ˆä¼‘é–’æ´»å‹• â†’ ä¼‘é–’æ¨™ç±¤ï¼‰ï¼š
è¼¸å…¥ï¼š"æ˜å¤©ä¸‹åˆ5é»å»é¤å»³åƒé£¯"
è¼¸å‡ºï¼š
{{
  "title": "åƒé£¯",
  "startTime": "2025-01-21T17:00:00",
  "endTime": "2025-01-21T18:00:00",
  "location": "é¤å»³",
  "description": "",
  "isAllDay": false,
  "participants": [],
  "labelId": "label_9"
}}

ç¯„ä¾‹ 2ï¼ˆå·¥ä½œç›¸é—œ â†’ å·¥ä½œæ¨™ç±¤ï¼‰ï¼š
è¼¸å…¥ï¼š"ä¸‹é€±ä¸‰æ—©ä¸Šåé»åœ¨å’–å•¡å»³è·Ÿ Amy è¨è«–å°ˆæ¡ˆ"
è¼¸å‡ºï¼š
{{
  "title": "è·Ÿ Amy è¨è«–å°ˆæ¡ˆ",
  "startTime": "2025-01-29T10:00:00",
  "endTime": "2025-01-29T11:00:00",
  "location": "å’–å•¡å»³",
  "description": "",
  "isAllDay": false,
  "participants": ["Amy"],
  "labelId": "label_1"
}}

ç¯„ä¾‹ 3ï¼ˆå‡ºå·® â†’ æ—…è¡Œæ¨™ç±¤ï¼‰ï¼š
è¼¸å…¥ï¼š"å¾Œå¤©æ•´å¤©è¦å‡ºå·®ï¼Œè¨˜å¾—å¸¶ç­†é›»"
è¼¸å‡ºï¼š
{{
  "title": "å‡ºå·®",
  "startTime": "2025-01-22T00:00:00",
  "endTime": "2025-01-22T23:59:59",
  "location": "",
  "description": "è¨˜å¾—å¸¶ç­†é›»",
  "isAllDay": true,
  "participants": [],
  "labelId": "label_11"
}}

ç¯„ä¾‹ 4ï¼ˆå¨›æ¨‚ â†’ ä¼‘é–’æ¨™ç±¤ï¼‰ï¼š
è¼¸å…¥ï¼š"ç¦®æ‹œäº”æ™šä¸Š7é»åŠå’Œå°æ˜å»çœ‹é›»å½±"
è¼¸å‡ºï¼š
{{
  "title": "çœ‹é›»å½±",
  "startTime": "2025-01-24T19:30:00",
  "endTime": "2025-01-24T20:30:00",
  "location": "",
  "description": "",
  "isAllDay": false,
  "participants": ["å°æ˜"],
  "labelId": "label_9"
}}

ç¯„ä¾‹ 5ï¼ˆé–‹æœƒ â†’ æœƒè­°æ¨™ç±¤ï¼‰ï¼š
è¼¸å…¥ï¼š"1æœˆ30è™Ÿä¸‹åˆä¸‰é»åˆ°äº”é»åœ¨æœƒè­°å®¤é–‹æœƒ"
è¼¸å‡ºï¼š
{{
  "title": "é–‹æœƒ",
  "startTime": "2025-01-30T15:00:00",
  "endTime": "2025-01-30T17:00:00",
  "location": "æœƒè­°å®¤",
  "description": "",
  "isAllDay": false,
  "participants": [],
  "labelId": "label_6"
}}

ç¯„ä¾‹ 6ï¼ˆç„¡æ¨™ç±¤åˆ—è¡¨æ™‚ â†’ nullï¼‰ï¼š
è¼¸å…¥ï¼š"ä»Šå¤©ä¸­åˆåƒé£¯"
è¼¸å‡ºï¼š
{{
  "title": "åƒé£¯",
  "startTime": "{current_date}T12:00:00",
  "endTime": "{current_date}T13:00:00",
  "location": "",
  "description": "",
  "isAllDay": false,
  "participants": [],
  "labelId": null
}}

=== é‡è¦æé†’ ===
- åªè¼¸å‡ºç´” JSON æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡‹æˆ–è¨»è§£
- ç¢ºä¿æ™‚é–“é‚è¼¯æ­£ç¢ºï¼ˆçµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹æ™‚é–“ï¼‰
- å¦‚æœè³‡è¨Šä¸è¶³ï¼Œä½¿ç”¨åˆç†çš„é è¨­å€¼
- æ¨™é¡Œå¿…é ˆç°¡æ½”ï¼Œä¸è¦åŒ…å«æ™‚é–“åœ°é»ç­‰å†—é¤˜è³‡è¨Š
- **labelId æ¬„ä½æ¥µç‚ºé‡è¦**ï¼š
  * å¦‚æœæœ‰æä¾›æ¨™ç±¤åˆ—è¡¨ï¼Œä½ å¿…é ˆæ ¹æ“šè¡Œç¨‹å…§å®¹èªçœŸæ¨æ–·æœ€é©åˆçš„æ¨™ç±¤ ID
  * ã€Œé–‹æœƒã€ç›¸é—œå…§å®¹ â†’ å¿…é ˆé¸æ“‡ã€Œæœƒè­°ã€æˆ–ã€Œå·¥ä½œã€æ¨™ç±¤
  * åªæœ‰åœ¨å®Œå…¨ç„¡æ³•åˆ¤æ–·æ™‚æ‰è¨­ç‚º null
- JSON è¼¸å‡ºå¿…é ˆåŒ…å«ä»¥ä¸‹æ‰€æœ‰æ¬„ä½ï¼štitle, startTime, endTime, location, description, isAllDay, participants, labelId
"""
            
            # å‘¼å« GPT API
            response = self.client.chat.completions.create(
                model="gpt-4",  # æˆ–ä½¿ç”¨ "gpt-3.5-turbo" é™ä½æˆæœ¬
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"è«‹è§£æä»¥ä¸‹è¡Œç¨‹æè¿°ï¼š\n{text}"}
                ],
                temperature=0.3,  # é™ä½éš¨æ©Ÿæ€§ï¼Œæé«˜æº–ç¢ºæ€§
                max_tokens=500,
            )
            
            # å–å¾—å›æ‡‰å…§å®¹
            result_text = response.choices[0].message.content
            logger.info(f"GPT å›æ‡‰ï¼š{result_text}")
            
            # è§£æ JSON
            result = json.loads(result_text)
            
            # é©—è­‰å¿…è¦æ¬„ä½
            required_fields = ["title", "startTime", "endTime"]
            for field in required_fields:
                if field not in result:
                    raise ValueError(f"ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š{field}")
            
            # é©—è­‰æ™‚é–“æ ¼å¼
            try:
                datetime.fromisoformat(result["startTime"])
                datetime.fromisoformat(result["endTime"])
            except ValueError as e:
                raise ValueError(f"æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼š{e}")
            
            # è¨˜éŒ„æ¨æ–·çš„ labelId
            inferred_label = result.get("labelId")
            if inferred_label:
                logger.info(f"ğŸ·ï¸ GPT æ¨æ–·çš„æ¨™ç±¤ IDï¼š{inferred_label}")
            else:
                logger.warning("âš ï¸ GPT æœªæ¨æ–·å‡ºæ¨™ç±¤ï¼ˆlabelId ç‚º null æˆ–æœªè¨­ç½®ï¼‰")

            logger.info(f"è§£æå®Œæˆï¼š{result}")
            return result
            
        except json.JSONDecodeError as e:
            logger.error(f"JSON è§£æå¤±æ•—ï¼š{e}")
            logger.error(f"åŸå§‹å›æ‡‰ï¼š{result_text}")
            raise Exception(f"JSON è§£æå¤±æ•—ï¼š{str(e)}")
        
        except Exception as e:
            logger.error(f"GPT è§£æå¤±æ•—ï¼š{e}")
            raise Exception(f"GPT è§£æå¤±æ•—ï¼š{str(e)}")

